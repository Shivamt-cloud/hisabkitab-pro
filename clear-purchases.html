<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clear Purchase History</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #dc3545;
      margin-top: 0;
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
      color: #856404;
    }
    button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #c82333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      display: block;
    }
    .status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      display: block;
    }
    .status.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
      display: block;
    }
    #count {
      font-weight: bold;
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üóëÔ∏è Clear Purchase History</h1>
    
    <div class="warning">
      <strong>‚ö†Ô∏è WARNING:</strong> This will permanently delete ALL purchase records from your database. This action cannot be undone!
    </div>

    <p>Click the button below to clear all purchase history.</p>

    <button id="clearBtn" onclick="clearPurchases()">Clear All Purchases</button>
    <button onclick="checkCount()">Check Purchase Count</button>

    <div id="status" class="status"></div>
  </div>

  <script>
    const DB_NAME = 'hisabkitab_db';
    const DB_VERSION = 9;
    const STORE_NAME = 'purchases';

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
    }

    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function getPurchaseCount() {
      try {
        const db = await openDB();
        const tx = db.transaction([STORE_NAME], 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.getAll();
        
        return new Promise((resolve, reject) => {
          request.onsuccess = () => resolve(request.result ? request.result.length : 0);
          request.onerror = () => reject(request.error);
        });
      } catch (error) {
        throw error;
      }
    }

    async function checkCount() {
      try {
        showStatus('Checking purchase count...', 'info');
        const count = await getPurchaseCount();
        showStatus(`Found <span id="count">${count}</span> purchase(s) in the database.`, count > 0 ? 'info' : 'success');
      } catch (error) {
        showStatus('Error checking count: ' + error.message, 'error');
      }
    }

    async function clearPurchases() {
      const confirmed = confirm('‚ö†Ô∏è Are you absolutely sure you want to delete ALL purchase history?\n\nThis action CANNOT be undone!');
      if (!confirmed) {
        showStatus('Operation cancelled.', 'info');
        return;
      }

      const finalConfirm = confirm('üî¥ FINAL CONFIRMATION:\n\nThis will PERMANENTLY delete ALL purchases from your database.\n\nClick OK to proceed, or Cancel to abort.');
      if (!finalConfirm) {
        showStatus('Operation cancelled.', 'info');
        return;
      }

      const btn = document.getElementById('clearBtn');
      btn.disabled = true;
      btn.textContent = 'Clearing...';

      try {
        showStatus('Opening database...', 'info');
        const db = await openDB();
        
        showStatus('Loading all purchases...', 'info');
        
        // Get all purchases first
        const tx1 = db.transaction([STORE_NAME], 'readonly');
        const store1 = tx1.objectStore(STORE_NAME);
        const getAllRequest = store1.getAll();
        
        const allPurchases = await new Promise((resolve, reject) => {
          getAllRequest.onsuccess = () => resolve(getAllRequest.result || []);
          getAllRequest.onerror = () => reject(getAllRequest.error);
        });
        
        const count = allPurchases.length;
        console.log(`Found ${count} purchases to delete`);
        
        if (count === 0) {
          showStatus('‚úÖ No purchases found. Database is already empty.', 'success');
          btn.disabled = false;
          btn.textContent = 'Clear All Purchases';
          db.close();
          return;
        }

        showStatus(`Deleting ${count} purchase(s) individually...`, 'info');
        
        // Method 1: Delete all individually
        const tx2 = db.transaction([STORE_NAME], 'readwrite');
        const store2 = tx2.objectStore(STORE_NAME);
        
        let deletedCount = 0;
        const deletePromises = allPurchases.map(purchase => {
          return new Promise((resolve, reject) => {
            const deleteRequest = store2.delete(purchase.id);
            deleteRequest.onsuccess = () => {
              deletedCount++;
              resolve();
            };
            deleteRequest.onerror = () => {
              console.error(`Failed to delete purchase ${purchase.id}:`, deleteRequest.error);
              reject(deleteRequest.error);
            };
          });
        });
        
        try {
          await Promise.all(deletePromises);
          console.log(`‚úÖ Deleted ${deletedCount} purchases individually`);
          
          // Wait for transaction to complete
          await new Promise((resolve) => {
            tx2.oncomplete = () => {
              console.log('‚úÖ Delete transaction completed');
              resolve();
            };
            tx2.onerror = () => {
              console.error('‚ùå Delete transaction error:', tx2.error);
              resolve();
            };
          });
        } catch (deleteError) {
          console.warn('‚ö†Ô∏è Individual delete had errors, trying clear method...', deleteError);
          
          // Method 2: Use clear() as fallback
          showStatus('Using clear method as fallback...', 'info');
          const tx3 = db.transaction([STORE_NAME], 'readwrite');
          const store3 = tx3.objectStore(STORE_NAME);
          const clearRequest = store3.clear();
          
          await new Promise((resolve, reject) => {
            clearRequest.onsuccess = () => {
              console.log(`‚úÖ Clear successful`);
              resolve();
            };
            clearRequest.onerror = () => {
              console.error('‚ùå Clear error:', clearRequest.error);
              reject(clearRequest.error);
            };
          });
          
          await new Promise((resolve) => {
            tx3.oncomplete = () => {
              console.log('‚úÖ Clear transaction completed');
              resolve();
            };
            tx3.onerror = () => {
              console.error('‚ùå Clear transaction error:', tx3.error);
              resolve();
            };
          });
        }
        
        // Verify deletion
        showStatus('Verifying deletion...', 'info');
        const tx4 = db.transaction([STORE_NAME], 'readonly');
        const store4 = tx4.objectStore(STORE_NAME);
        const verifyRequest = store4.count();
        
        const remainingCount = await new Promise((resolve, reject) => {
          verifyRequest.onsuccess = () => resolve(verifyRequest.result);
          verifyRequest.onerror = () => reject(verifyRequest.error);
        });
        
        console.log(`üìä Remaining purchases: ${remainingCount}`);
        
        if (remainingCount > 0) {
          console.warn(`‚ö†Ô∏è Warning: ${remainingCount} purchases still remain. Trying one more clear...`);
          showStatus(`Warning: ${remainingCount} purchases remain. Attempting final clear...`, 'info');
          
          const tx5 = db.transaction([STORE_NAME], 'readwrite');
          const store5 = tx5.objectStore(STORE_NAME);
          const finalClearRequest = store5.clear();
          
          await new Promise((resolve, reject) => {
            finalClearRequest.onsuccess = () => {
              console.log(`‚úÖ Final clear successful`);
              resolve();
            };
            finalClearRequest.onerror = () => {
              console.error('‚ùå Final clear error:', finalClearRequest.error);
              reject(finalClearRequest.error);
            };
          });
          
          await new Promise((resolve) => {
            tx5.oncomplete = () => resolve();
            tx5.onerror = () => resolve();
          });
        }

        db.close();
        
        showStatus(`‚úÖ Successfully cleared ${count} purchase(s)! The page will refresh in 3 seconds...`, 'success');
        
        setTimeout(() => {
          window.location.reload();
        }, 3000);

      } catch (error) {
        console.error('Error clearing purchases:', error);
        showStatus('‚ùå Error: ' + error.message + '\n\nCheck browser console for details.', 'error');
        btn.disabled = false;
        btn.textContent = 'Clear All Purchases';
      }
    }

    // Check count on page load
    window.addEventListener('load', () => {
      checkCount();
    });
  </script>
</body>
</html>

